$(function(){

	var icons = {
		edit: 'M25.31,2.872l-3.384-2.127c-0.854-0.536-1.979-0.278-2.517,0.576l-1.334,2.123l6.474,4.066l1.335-2.122C26.42,4.533,26.164,3.407,25.31,2.872zM6.555,21.786l6.474,4.066L23.581,9.054l-6.477-4.067L6.555,21.786zM5.566,26.952l-0.143,3.819l3.379-1.787l3.14-1.658l-6.246-3.925L5.566,26.952z',
		history: 'M16,1.466C7.973,1.466,1.466,7.973,1.466,16c0,8.027,6.507,14.534,14.534,14.534c8.027,0,14.534-6.507,14.534-14.534C30.534,7.973,24.027,1.466,16,1.466zM16,27.533C9.639,27.533,4.466,22.359,4.466,16C4.466,9.64,9.639,4.466,16,4.466c6.361,0,11.533,5.173,11.533,11.534C27.533,22.361,22.359,27.533,16,27.533zM15.999,5.125c-0.553,0-0.999,0.448-0.999,1v9.221L8.954,17.99c-0.506,0.222-0.736,0.812-0.514,1.318c0.164,0.375,0.53,0.599,0.915,0.599c0.134,0,0.271-0.027,0.401-0.085l6.626-2.898c0.005-0.002,0.009-0.004,0.013-0.006l0.004-0.002c0.015-0.006,0.023-0.02,0.037-0.025c0.104-0.052,0.201-0.113,0.279-0.195c0.034-0.034,0.053-0.078,0.079-0.117c0.048-0.064,0.101-0.127,0.13-0.204c0.024-0.06,0.026-0.125,0.038-0.189C16.975,16.121,17,16.064,17,15.999V6.124C17,5.573,16.552,5.125,15.999,5.125z',
		error: 'M29.225,23.567l-3.778-6.542c-1.139-1.972-3.002-5.2-4.141-7.172l-3.778-6.542c-1.14-1.973-3.003-1.973-4.142,0L9.609,9.853c-1.139,1.972-3.003,5.201-4.142,7.172L1.69,23.567c-1.139,1.974-0.207,3.587,2.071,3.587h23.391C29.432,27.154,30.363,25.541,29.225,23.567zM16.536,24.58h-2.241v-2.151h2.241V24.58zM16.428,20.844h-2.023l-0.201-9.204h2.407L16.428,20.844z',
		profile: 'M20.771,12.364c0,0,0.849-3.51,0-4.699c-0.85-1.189-1.189-1.981-3.058-2.548s-1.188-0.454-2.547-0.396c-1.359,0.057-2.492,0.792-2.492,1.188c0,0-0.849,0.057-1.188,0.397c-0.34,0.34-0.906,1.924-0.906,2.321s0.283,3.058,0.566,3.624l-0.337,0.113c-0.283,3.283,1.132,3.68,1.132,3.68c0.509,3.058,1.019,1.756,1.019,2.548s-0.51,0.51-0.51,0.51s-0.452,1.245-1.584,1.698c-1.132,0.452-7.416,2.886-7.927,3.396c-0.511,0.511-0.453,2.888-0.453,2.888h26.947c0,0,0.059-2.377-0.452-2.888c-0.512-0.511-6.796-2.944-7.928-3.396c-1.132-0.453-1.584-1.698-1.584-1.698s-0.51,0.282-0.51-0.51s0.51,0.51,1.02-2.548c0,0,1.414-0.397,1.132-3.68H20.771z',
		users: 'M21.053,20.8c-1.132-0.453-1.584-1.698-1.584-1.698s-0.51,0.282-0.51-0.51s0.51,0.51,1.02-2.548c0,0,1.414-0.397,1.132-3.68h-0.34c0,0,0.849-3.51,0-4.699c-0.85-1.189-1.189-1.981-3.058-2.548s-1.188-0.454-2.547-0.396c-1.359,0.057-2.492,0.792-2.492,1.188c0,0-0.849,0.057-1.188,0.397c-0.34,0.34-0.906,1.924-0.906,2.321s0.283,3.058,0.566,3.624l-0.337,0.113c-0.283,3.283,1.132,3.68,1.132,3.68c0.509,3.058,1.019,1.756,1.019,2.548s-0.51,0.51-0.51,0.51s-0.452,1.245-1.584,1.698c-1.132,0.452-7.416,2.886-7.927,3.396c-0.511,0.511-0.453,2.888-0.453,2.888h26.947c0,0,0.059-2.377-0.452-2.888C28.469,23.686,22.185,21.252,21.053,20.8zM8.583,20.628c-0.099-0.18-0.148-0.31-0.148-0.31s-0.432,0.239-0.432-0.432s0.432,0.432,0.864-2.159c0,0,1.199-0.336,0.959-3.119H9.538c0,0,0.143-0.591,0.237-1.334c-0.004-0.308,0.006-0.636,0.037-0.996l0.038-0.426c-0.021-0.492-0.107-0.939-0.312-1.226C8.818,9.619,8.53,8.947,6.947,8.467c-1.583-0.48-1.008-0.385-2.159-0.336C3.636,8.179,2.676,8.802,2.676,9.139c0,0-0.72,0.048-1.008,0.336c-0.271,0.271-0.705,1.462-0.757,1.885v0.281c0.047,0.653,0.258,2.449,0.469,2.872l-0.286,0.096c-0.239,2.783,0.959,3.119,0.959,3.119c0.432,2.591,0.864,1.488,0.864,2.159s-0.432,0.432-0.432,0.432s-0.383,1.057-1.343,1.439c-0.061,0.024-0.139,0.056-0.232,0.092v5.234h0.575c-0.029-1.278,0.077-2.927,0.746-3.594C2.587,23.135,3.754,22.551,8.583,20.628zM30.913,11.572c-0.04-0.378-0.127-0.715-0.292-0.946c-0.719-1.008-1.008-1.679-2.59-2.159c-1.584-0.48-1.008-0.385-2.16-0.336C24.72,8.179,23.76,8.802,23.76,9.139c0,0-0.719,0.048-1.008,0.336c-0.271,0.272-0.709,1.472-0.758,1.891h0.033l0.08,0.913c0.02,0.231,0.022,0.436,0.027,0.645c0.09,0.666,0.21,1.35,0.33,1.589l-0.286,0.096c-0.239,2.783,0.96,3.119,0.96,3.119c0.432,2.591,0.863,1.488,0.863,2.159s-0.432,0.432-0.432,0.432s-0.053,0.142-0.163,0.338c4.77,1.9,5.927,2.48,6.279,2.834c0.67,0.667,0.775,2.315,0.746,3.594h0.48v-5.306c-0.016-0.006-0.038-0.015-0.052-0.021c-0.959-0.383-1.343-1.439-1.343-1.439s-0.433,0.239-0.433-0.432s0.433,0.432,0.864-2.159c0,0,0.804-0.229,0.963-1.841v-1.227c-0.001-0.018-0.001-0.033-0.003-0.051h-0.289c0,0,0.215-0.89,0.292-1.861V11.572z',
		settings: 'M17.41,20.395l-0.778-2.723c0.228-0.2,0.442-0.414,0.644-0.643l2.721,0.778c0.287-0.418,0.534-0.862,0.755-1.323l-2.025-1.96c0.097-0.288,0.181-0.581,0.241-0.883l2.729-0.684c0.02-0.252,0.039-0.505,0.039-0.763s-0.02-0.51-0.039-0.762l-2.729-0.684c-0.061-0.302-0.145-0.595-0.241-0.883l2.026-1.96c-0.222-0.46-0.469-0.905-0.756-1.323l-2.721,0.777c-0.201-0.228-0.416-0.442-0.644-0.643l0.778-2.722c-0.418-0.286-0.863-0.534-1.324-0.755l-1.96,2.026c-0.287-0.097-0.581-0.18-0.883-0.241l-0.683-2.73c-0.253-0.019-0.505-0.039-0.763-0.039s-0.51,0.02-0.762,0.039l-0.684,2.73c-0.302,0.061-0.595,0.144-0.883,0.241l-1.96-2.026C7.048,3.463,6.604,3.71,6.186,3.997l0.778,2.722C6.736,6.919,6.521,7.134,6.321,7.361L3.599,6.583C3.312,7.001,3.065,7.446,2.844,7.907l2.026,1.96c-0.096,0.288-0.18,0.581-0.241,0.883l-2.73,0.684c-0.019,0.252-0.039,0.505-0.039,0.762s0.02,0.51,0.039,0.763l2.73,0.684c0.061,0.302,0.145,0.595,0.241,0.883l-2.026,1.96c0.221,0.46,0.468,0.905,0.755,1.323l2.722-0.778c0.2,0.229,0.415,0.442,0.643,0.643l-0.778,2.723c0.418,0.286,0.863,0.533,1.323,0.755l1.96-2.026c0.288,0.097,0.581,0.181,0.883,0.241l0.684,2.729c0.252,0.02,0.505,0.039,0.763,0.039s0.51-0.02,0.763-0.039l0.683-2.729c0.302-0.061,0.596-0.145,0.883-0.241l1.96,2.026C16.547,20.928,16.992,20.681,17.41,20.395zM11.798,15.594c-1.877,0-3.399-1.522-3.399-3.399s1.522-3.398,3.399-3.398s3.398,1.521,3.398,3.398S13.675,15.594,11.798,15.594zM27.29,22.699c0.019-0.547-0.06-1.104-0.23-1.654l1.244-1.773c-0.188-0.35-0.4-0.682-0.641-0.984l-2.122,0.445c-0.428-0.364-0.915-0.648-1.436-0.851l-0.611-2.079c-0.386-0.068-0.777-0.105-1.173-0.106l-0.974,1.936c-0.279,0.054-0.558,0.128-0.832,0.233c-0.257,0.098-0.497,0.22-0.727,0.353L17.782,17.4c-0.297,0.262-0.568,0.545-0.813,0.852l0.907,1.968c-0.259,0.495-0.437,1.028-0.519,1.585l-1.891,1.06c0.019,0.388,0.076,0.776,0.164,1.165l2.104,0.519c0.231,0.524,0.541,0.993,0.916,1.393l-0.352,2.138c0.32,0.23,0.66,0.428,1.013,0.6l1.715-1.32c0.536,0.141,1.097,0.195,1.662,0.15l1.452,1.607c0.2-0.057,0.399-0.118,0.596-0.193c0.175-0.066,0.34-0.144,0.505-0.223l0.037-2.165c0.455-0.339,0.843-0.747,1.152-1.206l2.161-0.134c0.152-0.359,0.279-0.732,0.368-1.115L27.29,22.699zM23.127,24.706c-1.201,0.458-2.545-0.144-3.004-1.345s0.143-2.546,1.344-3.005c1.201-0.458,2.547,0.144,3.006,1.345C24.931,22.902,24.328,24.247,23.127,24.706z',
		cog: 'M26.974,16.514l3.765-1.991c-0.074-0.738-0.217-1.454-0.396-2.157l-4.182-0.579c-0.362-0.872-0.84-1.681-1.402-2.423l1.594-3.921c-0.524-0.511-1.09-0.977-1.686-1.406l-3.551,2.229c-0.833-0.438-1.73-0.77-2.672-0.984l-1.283-3.976c-0.364-0.027-0.728-0.056-1.099-0.056s-0.734,0.028-1.099,0.056l-1.271,3.941c-0.967,0.207-1.884,0.543-2.738,0.986L7.458,4.037C6.863,4.466,6.297,4.932,5.773,5.443l1.55,3.812c-0.604,0.775-1.11,1.629-1.49,2.55l-4.05,0.56c-0.178,0.703-0.322,1.418-0.395,2.157l3.635,1.923c0.041,1.013,0.209,1.994,0.506,2.918l-2.742,3.032c0.319,0.661,0.674,1.303,1.085,1.905l4.037-0.867c0.662,0.72,1.416,1.351,2.248,1.873l-0.153,4.131c0.663,0.299,1.352,0.549,2.062,0.749l2.554-3.283C15.073,26.961,15.532,27,16,27c0.507,0,1.003-0.046,1.491-0.113l2.567,3.301c0.711-0.2,1.399-0.45,2.062-0.749l-0.156-4.205c0.793-0.513,1.512-1.127,2.146-1.821l4.142,0.889c0.411-0.602,0.766-1.243,1.085-1.905l-2.831-3.131C26.778,18.391,26.93,17.467,26.974,16.514zM20.717,21.297l-1.785,1.162l-1.098-1.687c-0.571,0.22-1.186,0.353-1.834,0.353c-2.831,0-5.125-2.295-5.125-5.125c0-2.831,2.294-5.125,5.125-5.125c2.83,0,5.125,2.294,5.125,5.125c0,1.414-0.573,2.693-1.499,3.621L20.717,21.297z', 
		units: 'M16,3.5c-4.142,0-7.5,3.358-7.5,7.5c0,4.143,7.5,18.121,7.5,18.121S23.5,15.143,23.5,11C23.5,6.858,20.143,3.5,16,3.5z M16,14.584c-1.979,0-3.584-1.604-3.584-3.584S14.021,7.416,16,7.416S19.584,9.021,19.584,11S17.979,14.584,16,14.584z',
		live: 'M16,1.466C7.973,1.466,1.466,7.973,1.466,16c0,8.027,6.507,14.534,14.534,14.534c8.027,0,14.534-6.507,14.534-14.534C30.534,7.973,24.027,1.466,16,1.466zM19.158,23.269c-0.079,0.064-0.183,0.13-0.105,0.207c0.078,0.078-0.09,0.131-0.09,0.17s0.104,0.246,0.052,0.336c-0.052,0.092-0.091,0.223-0.13,0.301c-0.039,0.077-0.131,0.155-0.104,0.272c0.025,0.116-0.104,0.077-0.104,0.194c0,0.116,0.116,0.065,0.09,0.208c-0.025,0.144-0.09,0.183-0.09,0.285c0,0.104,0.064,0.247,0.064,0.286s-0.064,0.17-0.155,0.272c-0.092,0.104-0.155,0.17-0.144,0.233c0.014,0.065,0.104,0.144,0.091,0.184c-0.013,0.037-0.129,0.168-0.116,0.259c0.014,0.09,0.129,0.053,0.155,0.116c0.026,0.065-0.155,0.118-0.078,0.183c0.078,0.064,0.183,0.051,0.156,0.208c-0.019,0.112,0.064,0.163,0.126,0.198c-0.891,0.221-1.818,0.352-2.777,0.352C9.639,27.533,4.466,22.36,4.466,16c0-2.073,0.557-4.015,1.518-5.697c0.079-0.042,0.137-0.069,0.171-0.062c0.065,0.013,0.079,0.104,0.183,0.13c0.104,0.026,0.195-0.078,0.26-0.117c0.064-0.039,0.116-0.195,0.051-0.182c-0.065,0.013-0.234,0-0.234,0s0.183-0.104,0.183-0.169s0.025-0.169,0.129-0.208C6.83,9.655,6.83,9.681,6.765,9.837C6.7,9.993,6.896,9.928,6.973,9.863s0.13-0.013,0.272-0.104c0.143-0.091,0.143-0.143,0.221-0.143c0.078,0,0.221,0.143,0.299,0.091c0.077-0.052,0.299,0.065,0.429,0.065c0.129,0,0.545,0.169,0.624,0.169c0.078,0,0.312,0.09,0.325,0.259c0.013,0.169,0.09,0.156,0.168,0.156s0.26,0.065,0.26,0.13c0,0.065-0.052,0.325,0.078,0.39c0.129,0.064,0.247,0.169,0.299,0.143c0.052-0.026,0-0.233-0.064-0.26c-0.065-0.026-0.027-0.117-0.052-0.169c-0.026-0.051,0.078-0.051,0.117,0.039c0.039,0.091,0.143,0.26,0.208,0.26c0.064,0,0.208,0.156,0.168,0.247c-0.039,0.091,0.039,0.221,0.156,0.221c0.116,0,0.26,0.182,0.312,0.195c0.052,0.013,0.117,0.078,0.117,0.117c0,0.04,0.065,0.26,0.065,0.351c0,0.09-0.04,0.454-0.053,0.597s0.104,0.39,0.234,0.52c0.129,0.13,0.246,0.377,0.324,0.429c0.079,0.052,0.13,0.195,0.247,0.182c0.117-0.013,0.195,0.078,0.299,0.26c0.104,0.182,0.208,0.48,0.286,0.506c0.078,0.026,0.208,0.117,0.142,0.182c-0.064,0.064-0.168,0.208-0.051,0.208c0.117,0,0.156-0.065,0.247,0.053c0.09,0.116,0.208,0.181,0.194,0.26c-0.013,0.077,0.104,0.103,0.156,0.116c0.052,0.013,0.169,0.247,0.286,0.143c0.117-0.104-0.155-0.259-0.234-0.326c-0.078-0.064,0-0.207-0.182-0.35c-0.182-0.143-0.156-0.247-0.286-0.351c-0.13-0.104-0.233-0.195-0.104-0.286c0.13-0.091,0.143,0.091,0.195,0.208c0.052,0.116,0.324,0.351,0.441,0.454c0.117,0.104,0.326,0.468,0.39,0.468s0.247,0.208,0.247,0.208s0.103,0.168,0.064,0.22c-0.039,0.052,0.053,0.247,0.144,0.299c0.09,0.052,0.455,0.22,0.507,0.247c0.052,0.027,0.155,0.221,0.299,0.221c0.142,0,0.247,0.014,0.286,0.053c0.039,0.038,0.155,0.194,0.234,0.104c0.078-0.092,0.09-0.131,0.208-0.131c0.117,0,0.168,0.091,0.233,0.156c0.065,0.065,0.247,0.235,0.338,0.222c0.091-0.013,0.208,0.104,0.273,0.064s0.169,0.025,0.22,0.052c0.054,0.026,0.234,0.118,0.222,0.272c-0.013,0.157,0.103,0.195,0.182,0.234c0.078,0.039,0.182,0.13,0.248,0.195c0.064,0.063,0.206,0.077,0.246,0.116c0.039,0.039,0.065,0.117,0.182,0.052c0.116-0.064,0.092-0.181,0.092-0.181s0.129-0.026,0.194,0.026c0.064,0.05,0.104,0.22,0.144,0.246c0.038,0.026,0.115,0.221,0.063,0.362c-0.051,0.145-0.038,0.286-0.091,0.286c-0.052,0-0.116,0.17-0.195,0.209c-0.076,0.039-0.285,0.221-0.272,0.286c0.013,0.063,0.131,0.258,0.104,0.35c-0.025,0.091-0.194,0.195-0.154,0.338c0.038,0.144,0.312,0.183,0.323,0.312c0.014,0.131,0.209,0.417,0.235,0.546c0.025,0.13,0.246,0.272,0.246,0.453c0,0.184,0.312,0.3,0.377,0.312c0.063,0.013,0.182,0.131,0.272,0.17s0.169,0.116,0.233,0.221s0.053,0.261,0.053,0.299c0,0.039-0.039,0.44-0.078,0.674C19.145,23.021,19.235,23.203,19.158,23.269zM10.766,11.188c0.039,0.013,0.117,0.091,0.156,0.091c0.04,0,0.234,0.156,0.286,0.208c0.053,0.052,0.053,0.195-0.013,0.208s-0.104-0.143-0.117-0.208c-0.013-0.065-0.143-0.065-0.208-0.104C10.805,11.344,10.66,11.152,10.766,11.188zM27.51,16.41c-0.144,0.182-0.13,0.272-0.195,0.286c-0.064,0.013,0.065,0.065,0.09,0.194c0.022,0.112-0.065,0.224,0.063,0.327c-0.486,4.619-3.71,8.434-8.016,9.787c-0.007-0.011-0.019-0.025-0.021-0.034c-0.027-0.078-0.027-0.233,0.064-0.285c0.091-0.053,0.312-0.233,0.363-0.272c0.052-0.04,0.13-0.221,0.091-0.247c-0.038-0.026-0.232,0-0.26-0.039c-0.026-0.039-0.026-0.092,0.104-0.182c0.13-0.091,0.195-0.222,0.247-0.26c0.052-0.039,0.155-0.117,0.195-0.209c0.038-0.09-0.041-0.039-0.118-0.039s-0.117-0.142-0.117-0.207s0.195,0.026,0.339,0.052c0.143,0.024,0.077-0.065,0.064-0.142c-0.013-0.078,0.026-0.209,0.105-0.17c0.076,0.039,0.479-0.013,0.531-0.026c0.052-0.013,0.194-0.246,0.246-0.312c0.053-0.065,0.064-0.129,0-0.168c-0.065-0.04-0.143-0.184-0.168-0.221c-0.026-0.041-0.039-0.274-0.013-0.34c0.025-0.063,0,0.377,0.181,0.43c0.183,0.052,0.286,0.078,0.455-0.078c0.169-0.155,0.298-0.26,0.312-0.363c0.013-0.104,0.052-0.209,0.117-0.246c0.065-0.039,0.104,0.103,0.182-0.065c0.078-0.17,0.156-0.157,0.234-0.299c0.077-0.144-0.13-0.325,0.024-0.43c0.157-0.103,0.43-0.233,0.43-0.233s0.078-0.039,0.234-0.078c0.155-0.038,0.324-0.014,0.376-0.09c0.052-0.079,0.104-0.247,0.182-0.338c0.079-0.092,0.169-0.234,0.13-0.299c-0.039-0.065,0.104-0.352,0.091-0.429c-0.013-0.078-0.13-0.261,0.065-0.416s0.402-0.391,0.416-0.454c0.012-0.065,0.169-0.338,0.154-0.469c-0.012-0.129-0.154-0.285-0.245-0.325c-0.092-0.037-0.286-0.05-0.364-0.154s-0.299-0.208-0.377-0.182c-0.077,0.026-0.208,0.051-0.312-0.015c-0.104-0.063-0.272-0.143-0.337-0.194c-0.066-0.051-0.234-0.09-0.312-0.09s-0.065-0.053-0.182,0.103c-0.117,0.157,0,0.209-0.208,0.182c-0.209-0.024,0.025-0.038,0.144-0.194c0.115-0.155-0.014-0.247-0.144-0.207c-0.13,0.039-0.039,0.117-0.247,0.156c-0.207,0.038-0.207-0.092-0.077-0.117c0.13-0.026,0.363-0.143,0.363-0.194c0-0.053-0.026-0.196-0.13-0.196s-0.078-0.129-0.233-0.297c-0.156-0.17-0.351-0.274-0.508-0.249c-0.154,0.026-0.272,0.065-0.35-0.076c-0.078-0.144-0.169-0.17-0.222-0.247c-0.051-0.078-0.182,0-0.221-0.039s-0.039-0.039-0.039-0.039s-0.169,0.039-0.077-0.078c0.09-0.117,0.129-0.338,0.09-0.325c-0.038,0.013-0.104,0.196-0.168,0.183c-0.064-0.013-0.014-0.04-0.144-0.117c-0.13-0.078-0.337-0.013-0.337,0.052c0,0.065-0.065,0.117-0.065,0.117s-0.039-0.038-0.078-0.117c-0.039-0.078-0.221-0.091-0.312-0.013c-0.09,0.078-0.142-0.196-0.207-0.196s-0.194,0.065-0.26,0.184c-0.064,0.116-0.038,0.285-0.092,0.272c-0.05-0.013-0.063-0.233-0.05-0.312c0.012-0.079,0.155-0.208,0.05-0.234c-0.103-0.026-0.259,0.13-0.323,0.143c-0.065,0.013-0.195,0.104-0.273,0.209c-0.077,0.103-0.116,0.168-0.195,0.207c-0.077,0.039-0.193,0-0.167-0.039c0.025-0.039-0.222-0.181-0.261-0.13c-0.04,0.052-0.155,0.091-0.272,0.144c-0.117,0.052-0.222-0.065-0.247-0.117s-0.079-0.064-0.091-0.234c-0.013-0.168,0.027-0.351,0.065-0.454c0.038-0.104-0.195-0.312-0.286-0.3c-0.091,0.015-0.182,0.105-0.272,0.091c-0.092-0.012-0.052-0.038-0.195-0.038c-0.143,0-0.026-0.025,0-0.143c0.025-0.116-0.052-0.273,0.092-0.377c0.142-0.104,0.091-0.351,0-0.363c-0.092-0.014-0.261,0.039-0.377,0.026c-0.116-0.014-0.208,0.091-0.169,0.207c0.039,0.117-0.065,0.195-0.104,0.183c-0.039-0.013-0.09-0.078-0.234,0.026c-0.142,0.103-0.194,0.064-0.337-0.052c-0.143-0.118-0.299-0.234-0.325-0.416c-0.026-0.182-0.04-0.364,0.013-0.468c0.051-0.104,0.051-0.285-0.026-0.312c-0.078-0.025,0.09-0.155,0.181-0.181c0.092-0.026,0.234-0.143,0.26-0.195c0.026-0.052,0.156-0.04,0.298-0.04c0.143,0,0.169,0,0.312,0.078c0.143,0.078,0.169-0.039,0.169-0.078c0-0.039,0.052-0.117,0.208-0.104c0.156,0.013,0.376-0.052,0.416-0.013s0.116,0.195,0.194,0.143c0.079-0.051,0.104-0.143,0.131,0.014c0.025,0.155,0.09,0.39,0.208,0.429c0.116,0.039,0.052,0.194,0.168,0.207c0.115,0.013,0.17-0.246,0.131-0.337c-0.04-0.09-0.118-0.363-0.183-0.428c-0.064-0.065-0.064-0.234,0.064-0.286c0.13-0.052,0.442-0.312,0.532-0.389c0.092-0.079,0.338-0.144,0.261-0.248c-0.078-0.104-0.104-0.168-0.104-0.247s0.078-0.052,0.117,0s0.194-0.078,0.155-0.143c-0.038-0.064-0.026-0.155,0.065-0.143c0.091,0.013,0.116-0.065,0.078-0.117c-0.039-0.052,0.091-0.117,0.182-0.091c0.092,0.026,0.325-0.013,0.364-0.065c0.038-0.052-0.078-0.104-0.078-0.208c0-0.104,0.155-0.195,0.247-0.208c0.091-0.013,0.207,0,0.221-0.039c0.012-0.039,0.143-0.143,0.155-0.052c0.014,0.091,0,0.247,0.104,0.247c0.104,0,0.232-0.117,0.272-0.129c0.038-0.013,0.286-0.065,0.338-0.078c0.052-0.013,0.363-0.039,0.325-0.13c-0.039-0.09-0.078-0.181-0.118-0.22c-0.039-0.039-0.077,0.013-0.13,0.078c-0.051,0.065-0.143,0.065-0.168,0.013c-0.026-0.051,0.012-0.207-0.078-0.156c-0.092,0.052-0.104,0.104-0.157,0.078c-0.052-0.026-0.103-0.117-0.103-0.117s0.129-0.064,0.038-0.182c-0.09-0.117-0.221-0.091-0.35-0.025c-0.13,0.064-0.118,0.051-0.273,0.09s-0.234,0.078-0.234,0.078s0.209-0.129,0.299-0.208c0.091-0.078,0.209-0.117,0.286-0.195c0.078-0.078,0.285,0.039,0.285,0.039s0.105-0.104,0.105-0.039s-0.027,0.234,0.051,0.234c0.079,0,0.299-0.104,0.21-0.131c-0.093-0.026,0.129,0,0.219-0.065c0.092-0.065,0.194-0.065,0.247-0.09c0.052-0.026,0.092-0.143,0.182-0.143c0.092,0,0.13,0.117,0,0.195s-0.143,0.273-0.208,0.325c-0.064,0.052-0.026,0.117,0.078,0.104c0.104-0.013,0.194,0.013,0.286-0.013s0.143,0.026,0.168,0.065c0.026,0.039,0.104-0.039,0.104-0.039s0.169-0.039,0.221,0.026c0.053,0.064,0.092-0.039,0.053-0.104c-0.039-0.064-0.092-0.129-0.13-0.208c-0.039-0.078-0.091-0.104-0.194-0.078c-0.104,0.026-0.13-0.026-0.195-0.064c-0.065-0.04-0.118,0.052-0.065-0.04c0.053-0.09,0.078-0.117,0.117-0.195c0.039-0.078,0.209-0.221,0.039-0.259c-0.169-0.04-0.222-0.065-0.247-0.143c-0.026-0.078-0.221-0.221-0.272-0.221c-0.053,0-0.233,0-0.247-0.065c-0.013-0.065-0.143-0.208-0.208-0.273c-0.064-0.065-0.312-0.351-0.351-0.377c-0.039-0.026-0.091-0.013-0.208,0.143c-0.116,0.157-0.22,0.183-0.312,0.144c-0.091-0.039-0.104-0.026-0.193-0.13c-0.093-0.104,0.09-0.117,0.051-0.182c-0.04-0.064-0.247-0.091-0.377-0.104c-0.13-0.013-0.221-0.156-0.416-0.169c-0.194-0.013-0.428,0.026-0.493,0.026c-0.064,0-0.064,0.091-0.09,0.234c-0.027,0.143,0.09,0.182-0.027,0.208c-0.116,0.026-0.169,0.039-0.052,0.091c0.117,0.052,0.273,0.26,0.273,0.26s0,0.117-0.092,0.182c-0.09,0.065-0.182,0.13-0.233,0.053c-0.053-0.079-0.195-0.065-0.155,0.013c0.038,0.078,0.116,0.117,0.116,0.195c0,0.077,0.117,0.272,0.039,0.337c-0.078,0.065-0.168,0.014-0.233,0.026s-0.131-0.104-0.078-0.13c0.051-0.026-0.014-0.221-0.014-0.221s-0.155,0.221-0.143,0.104c0.014-0.117-0.064-0.13-0.064-0.221c0-0.091-0.079-0.13-0.194-0.104c-0.118,0.026-0.26-0.04-0.482-0.079c-0.22-0.039-0.311-0.064-0.493-0.156c-0.182-0.091-0.247-0.026-0.338-0.013c-0.091,0.013-0.052-0.182-0.169-0.207c-0.116-0.027-0.181,0.025-0.207-0.144c-0.026-0.168,0.039-0.208,0.324-0.39c0.286-0.182,0.247-0.26,0.468-0.286c0.22-0.026,0.325,0.026,0.325-0.039s0.052-0.325,0.052-0.195S16.95,9.109,16.832,9.2c-0.116,0.091-0.052,0.104,0.04,0.104c0.091,0,0.259-0.091,0.259-0.091s0.208-0.091,0.26-0.013c0.053,0.078,0.053,0.156,0.144,0.156s0.285-0.104,0.116-0.195c-0.168-0.091-0.272-0.078-0.376-0.182s-0.078-0.065-0.195-0.039c-0.116,0.026-0.116-0.039-0.156-0.039s-0.104,0.026-0.13-0.026c-0.025-0.052,0.014-0.065,0.145-0.065c0.129,0,0.285,0.039,0.285,0.039s0.155-0.052,0.194-0.065c0.039-0.013,0.247-0.039,0.208-0.155c-0.04-0.117-0.169-0.117-0.208-0.156s0.078-0.09,0.143-0.117c0.065-0.026,0.247,0,0.247,0s0.117,0.013,0.117-0.039S17.897,8.2,17.976,8.239s0,0.156,0.117,0.13c0.116-0.026,0.143,0,0.207,0.039c0.065,0.039-0.013,0.195-0.077,0.221c-0.065,0.025-0.169,0.077-0.026,0.09c0.144,0.014,0.246,0.014,0.246,0.014s0.092-0.091,0.131-0.169c0.038-0.078,0.104-0.026,0.155,0c0.052,0.025,0.247,0.065,0.065,0.117c-0.183,0.052-0.221,0.117-0.26,0.182c-0.038,0.065-0.053,0.104-0.221,0.065c-0.17-0.039-0.26-0.026-0.299,0.039c-0.039,0.064-0.013,0.273,0.053,0.247c0.063-0.026,0.129-0.026,0.207-0.052c0.078-0.026,0.39,0.026,0.467,0.013c0.078-0.013,0.209,0.13,0.248,0.104c0.039-0.026,0.117,0.052,0.194,0.104c0.078,0.052,0.052-0.117,0.194-0.013c0.144,0.104,0.065,0.104,0.144,0.104c0.076,0,0.246,0.013,0.246,0.013s0.014-0.129,0.144-0.104c0.13,0.026,0.245,0.169,0.232,0.064c-0.012-0.103,0.013-0.181-0.09-0.259c-0.104-0.078-0.272-0.13-0.299-0.169c-0.026-0.039-0.052-0.091-0.013-0.117c0.039-0.025,0.221,0.013,0.324,0.079c0.104,0.065,0.195,0.13,0.273,0.078c0.077-0.052,0.17-0.078,0.208-0.117c0.038-0.04,0.13-0.156,0.13-0.156s-0.391-0.051-0.441-0.117c-0.053-0.065-0.235-0.156-0.287-0.156s-0.194,0.091-0.246-0.039s-0.052-0.286-0.105-0.299c-0.05-0.013-0.597-0.091-0.674-0.13c-0.078-0.039-0.39-0.13-0.507-0.195s-0.286-0.156-0.389-0.156c-0.104,0-0.533,0.052-0.611,0.039c-0.078-0.013-0.312,0.026-0.403,0.039c-0.091,0.013,0.117,0.182-0.077,0.221c-0.195,0.039-0.169,0.065-0.13-0.13c0.038-0.195-0.131-0.247-0.299-0.169c-0.169,0.078-0.442,0.13-0.377,0.221c0.065,0.091-0.012,0.157,0.117,0.247c0.13,0.091,0.183,0.117,0.35,0.104c0.17-0.013,0.339,0.025,0.339,0.025s0,0.157-0.064,0.182c-0.065,0.026-0.169,0.026-0.196,0.104c-0.025,0.078-0.155,0.117-0.155,0.078s0.065-0.169-0.026-0.234c-0.09-0.065-0.117-0.078-0.221-0.013c-0.104,0.065-0.116,0.091-0.169-0.013C16.053,8.291,15.897,8.2,15.897,8.2s-0.104-0.129-0.182-0.194c-0.077-0.065-0.22-0.052-0.234,0.013c-0.013,0.064,0.026,0.129,0.078,0.247c0.052,0.117,0.104,0.337,0.013,0.351c-0.091,0.013-0.104,0.026-0.195,0.052c-0.091,0.026-0.13-0.039-0.13-0.143s-0.04-0.195-0.013-0.234c0.026-0.039-0.104,0.027-0.234,0c-0.13-0.025-0.233,0.052-0.104,0.092c0.13,0.039,0.157,0.194,0.039,0.233c-0.117,0.039-0.559,0-0.702,0s-0.35,0.039-0.39-0.039c-0.039-0.078,0.118-0.129,0.208-0.129c0.091,0,0.363,0.012,0.467-0.13c0.104-0.143-0.13-0.169-0.233-0.169c-0.104,0-0.183-0.039-0.299-0.155c-0.118-0.117,0.078-0.195,0.052-0.247c-0.026-0.052-0.156-0.014-0.272-0.014c-0.117,0-0.299-0.09-0.299,0.014c0,0.104,0.143,0.402,0.052,0.337c-0.091-0.064-0.078-0.156-0.143-0.234c-0.065-0.078-0.168-0.065-0.299-0.052c-0.129,0.013-0.35,0.052-0.415,0.039c-0.064-0.013-0.013-0.013-0.156-0.078c-0.142-0.065-0.208-0.052-0.312-0.117C12.091,7.576,12.182,7.551,12,7.538c-0.181-0.013-0.168,0.09-0.35,0.065c-0.182-0.026-0.234,0.013-0.416,0c-0.182-0.013-0.272-0.026-0.299,0.065c-0.025,0.091-0.078,0.247-0.156,0.247c-0.077,0-0.169,0.091,0.078,0.104c0.247,0.013,0.105,0.129,0.325,0.117c0.221-0.013,0.416-0.013,0.468-0.117c0.052-0.104,0.091-0.104,0.117-0.065c0.025,0.039,0.22,0.272,0.22,0.272s0.131,0.104,0.183,0.13c0.051,0.026-0.052,0.143-0.156,0.078c-0.104-0.065-0.299-0.051-0.377-0.116c-0.078-0.065-0.429-0.065-0.52-0.052c-0.09,0.013-0.247-0.039-0.299-0.039c-0.051,0-0.221,0.13-0.221,0.13S10.532,8.252,10.494,8.2c-0.039-0.052-0.104,0.052-0.156,0.065c-0.052,0.013-0.208-0.104-0.364-0.052C9.818,8.265,9.87,8.317,9.649,8.304s-0.272-0.052-0.35-0.039C9.22,8.278,9.22,8.278,9.22,8.278S9.233,8.33,9.143,8.382C9.052,8.434,8.986,8.499,8.921,8.421C8.857,8.343,8.818,8.343,8.779,8.33c-0.04-0.013-0.118-0.078-0.286-0.04C8.324,8.33,8.064,8.239,8.013,8.239c-0.04,0-0.313-0.015-0.491-0.033c2.109-2.292,5.124-3.74,8.478-3.74c2.128,0,4.117,0.589,5.83,1.598c-0.117,0.072-0.319,0.06-0.388,0.023c-0.078-0.043-0.158-0.078-0.475-0.061c-0.317,0.018-0.665,0.122-0.595,0.226c0.072,0.104-0.142,0.165-0.197,0.113c-0.055-0.052-0.309,0.06-0.293,0.165c0.016,0.104-0.039,0.225-0.175,0.199c-0.134-0.027-0.229,0.06-0.237,0.146c-0.007,0.087-0.309,0.147-0.332,0.147c-0.024,0-0.412-0.008-0.27,0.095c0.097,0.069,0.15,0.027,0.27,0.052c0.119,0.026,0.214,0.217,0.277,0.243c0.062,0.026,0.15,0,0.189-0.052c0.04-0.052,0.095-0.234,0.095-0.234s0,0.173,0.097,0.208c0.095,0.035,0.331-0.026,0.395-0.017c0.064,0.008,0.437,0.061,0.538,0.112c0.104,0.052,0.356,0.087,0.428,0.199c0.071,0.113,0.08,0.503,0.119,0.546c0.04,0.043,0.174-0.139,0.205-0.182c0.031-0.044,0.198-0.018,0.254,0.042c0.056,0.061,0.182,0.208,0.175,0.269C21.9,8.365,21.877,8.459,21.83,8.425c-0.048-0.034-0.127-0.025-0.096-0.095c0.032-0.069,0.048-0.217-0.015-0.217c-0.064,0-0.119,0-0.119,0s-0.12-0.035-0.199,0.095s-0.015,0.26,0.04,0.26s0.184,0,0.184,0.034c0,0.035-0.136,0.139-0.128,0.2c0.009,0.061,0.11,0.268,0.144,0.312c0.031,0.043,0.197,0.086,0.244,0.096c0.049,0.008-0.111,0.017-0.07,0.077c0.04,0.061,0.102,0.208,0.189,0.243c0.087,0.035,0.333,0.19,0.363,0.26c0.032,0.069,0.222-0.052,0.262-0.061c0.04-0.008,0.032,0.182,0.143,0.191c0.11,0.008,0.15-0.018,0.245-0.096s0.072-0.182,0.079-0.26c0.009-0.078,0-0.138,0.104-0.113c0.104,0.026,0.158-0.018,0.15-0.104c-0.008-0.087-0.095-0.191,0.07-0.217c0.167-0.026,0.254-0.138,0.357-0.138c0.103,0,0.389,0.043,0.419,0c0.032-0.043,0.167-0.243,0.254-0.251c0.067-0.007,0.224-0.021,0.385-0.042c1.582,1.885,2.561,4.284,2.673,6.905c-0.118,0.159-0.012,0.305,0.021,0.408c0.001,0.03,0.005,0.058,0.005,0.088c0,0.136-0.016,0.269-0.021,0.404C27.512,16.406,27.512,16.408,27.51,16.41zM17.794,12.084c-0.064,0.013-0.169-0.052-0.169-0.143s-0.091,0.169-0.04,0.247c0.053,0.078-0.104,0.169-0.155,0.169s-0.091-0.116-0.078-0.233c0.014-0.117-0.077-0.221-0.221-0.208c-0.143,0.014-0.208,0.13-0.259,0.169c-0.053,0.039-0.053,0.259-0.04,0.312s0.013,0.235-0.116,0.221c-0.118-0.013-0.092-0.233-0.079-0.312c0.014-0.078-0.039-0.273,0.014-0.376c0.053-0.104,0.207-0.143,0.312-0.156s0.324,0.065,0.363,0.052c0.04-0.014,0.222-0.014,0.312,0C17.729,11.837,17.858,12.071,17.794,12.084zM18.027,12.123c0.04,0.026,0.311-0.039,0.364,0.026c0.051,0.065-0.054,0.078-0.183,0.13c-0.129,0.052-0.169,0.039-0.221,0.104s-0.221,0.09-0.299,0.168c-0.078,0.079-0.217,0.125-0.246,0.065c-0.04-0.078,0.013-0.039,0.025-0.078c0.013-0.039,0.245-0.129,0.245-0.129S17.988,12.097,18.027,12.123zM16.988,11.668c-0.038,0.013-0.182-0.026-0.3-0.026c-0.116,0-0.091-0.078-0.143-0.064c-0.051,0.013-0.168,0.039-0.247,0.078c-0.078,0.039-0.208,0.03-0.208-0.04c0-0.104,0.052-0.078,0.221-0.143c0.169-0.065,0.352-0.247,0.429-0.169c0.078,0.078,0.221,0.169,0.312,0.182C17.144,11.5,17.026,11.655,16.988,11.668zM15.659,7.637c-0.079,0.026-0.347,0.139-0.321,0.199c0.01,0.023,0.078,0.069,0.19,0.052c0.113-0.018,0.276-0.035,0.355-0.043c0.078-0.009,0.095-0.139,0.009-0.147C15.805,7.689,15.736,7.611,15.659,7.637zM14.698,7.741c-0.061,0.026-0.243-0.043-0.338,0.018c-0.061,0.038-0.026,0.164,0.07,0.172c0.095,0.009,0.259-0.06,0.276-0.008c0.018,0.052,0.078,0.286,0.234,0.208c0.156-0.078,0.147-0.147,0.19-0.156c0.043-0.009-0.008-0.199-0.078-0.243C14.983,7.689,14.758,7.715,14.698,7.741zM14.385,7.005c0.017,0.044-0.008,0.078,0.113,0.095c0.121,0.018,0.173,0.035,0.243,0.035c0.069,0,0.042-0.113-0.018-0.19c-0.061-0.078-0.043-0.069-0.199-0.113c-0.156-0.043-0.312-0.043-0.416-0.035c-0.104,0.009-0.217-0.017-0.243,0.104c-0.013,0.062,0.07,0.112,0.174,0.112S14.368,6.962,14.385,7.005zM14.611,7.481c0.043,0.095,0.043,0.051,0.165,0.061C14.896,7.551,14.991,7.421,15,7.378c0.009-0.044-0.061-0.13-0.225-0.113c-0.165,0.017-0.667-0.026-0.736,0.034c-0.066,0.058,0,0.233-0.026,0.251c-0.026,0.017,0.009,0.095,0.077,0.078c0.069-0.017,0.104-0.182,0.157-0.182C14.299,7.447,14.568,7.386,14.611,7.481zM12.982,7.126c0.052,0.043,0.183,0.008,0.173-0.035c-0.008-0.043,0.053-0.217-0.051-0.225C13,6.858,12.854,6.962,12.697,7.014c-0.101,0.033-0.078,0.13-0.009,0.13S12.931,7.083,12.982,7.126zM13.72,7.282c-0.087,0.043-0.114,0.069-0.191,0.052c-0.078-0.017-0.078-0.156-0.217-0.13c-0.138,0.026-0.164,0.104-0.207,0.139s-0.139,0.061-0.173,0.043c-0.034-0.017-0.234-0.129-0.234-0.129s-0.416-0.018-0.433-0.07c-0.017-0.052-0.086-0.138-0.277-0.121s-0.52,0.13-0.572,0.13c-0.052,0,0.062,0.104-0.009,0.104c-0.069,0-0.155-0.008-0.181,0.069c-0.018,0.053,0.078,0.052,0.189,0.052c0.112,0,0.295,0,0.347-0.026c0.052-0.026,0.312-0.087,0.303-0.009c-0.009,0.079,0.104,0.199,0.164,0.182c0.061-0.017,0.183-0.13,0.243-0.086c0.061,0.043,0.07,0.146,0.13,0.173c0.061,0.025,0.226,0.025,0.304,0c0.077-0.027,0.294-0.027,0.389-0.009c0.095,0.018,0.373,0.069,0.399,0.018c0.026-0.053,0.104-0.061,0.112-0.113s0.051-0.216,0.051-0.216S13.806,7.239,13.72,7.282zM18.105,16.239c-0.119,0.021-0.091,0.252,0.052,0.21C18.3,16.407,18.223,16.217,18.105,16.239zM19.235,15.929c-0.104-0.026-0.221,0-0.299,0.013c-0.078,0.013-0.299,0.208-0.299,0.208s0.143,0.026,0.233,0.026c0.092,0,0.144,0.051,0.221,0.09c0.078,0.04,0.221-0.052,0.272-0.052c0.053,0,0.118,0.156,0.131-0.013C19.508,16.032,19.339,15.955,19.235,15.929zM15.616,7.507c-0.043-0.104-0.259-0.139-0.304-0.035C15.274,7.563,15.659,7.611,15.616,7.507zM18.093,15.292c0.143-0.026,0.064-0.144-0.053-0.13C17.922,15.175,17.949,15.318,18.093,15.292zM19.82,16.095c-0.119,0.022-0.092,0.253,0.051,0.211C20.015,16.264,19.937,16.074,19.82,16.095zM18.247,15.708c-0.09,0.013-0.285-0.09-0.389-0.182c-0.104-0.091-0.299-0.091-0.377-0.091c-0.077,0-0.39,0.091-0.39,0.091c-0.013,0.13,0.117,0.091,0.273,0.091s0.429-0.026,0.479,0.039c0.053,0.064,0.286,0.168,0.352,0.221c0.064,0.052,0.272,0.065,0.285,0.013S18.338,15.695,18.247,15.708zM16.698,7.412c-0.13-0.009-0.295-0.009-0.399,0c-0.104,0.008-0.182-0.069-0.26-0.113c-0.077-0.043-0.251-0.182-0.354-0.199c-0.104-0.017-0.086-0.017-0.303-0.069c-0.11-0.027-0.294-0.061-0.294-0.086c0-0.026-0.052,0.121,0.043,0.165c0.095,0.043,0.251,0.121,0.363,0.164c0.114,0.043,0.329,0.052,0.399,0.139c0.069,0.086,0.303,0.156,0.303,0.156l0.277,0.026c0,0,0.191-0.043,0.39-0.026c0.199,0.017,0.493,0.043,0.659,0.035c0.163-0.008,0.189-0.061,0.208-0.095c0.016-0.035-0.304-0.104-0.383-0.095C17.271,7.42,16.827,7.42,16.698,7.412zM17.182,9.404c-0.034,0.039,0.157,0.095,0.191,0.043C17.407,9.396,17.271,9.309,17.182,9.404zM17.764,9.585c0.086-0.035,0.043-0.139-0.079-0.104C17.547,9.521,17.676,9.62,17.764,9.585z',
		close: 'M25.747,25.746c-5.889,5.89-15.439,5.89-21.329,0c-5.89-5.889-5.89-15.439,0-21.329c5.89-5.89,15.439-5.89,21.329,0 C31.637,10.307,31.637,19.857,25.747,25.746z M12.833,15.008l-5.969,5.969l2.264,2.265l5.969-5.969l5.9,5.9l2.264-2.264l-5.9-5.901 l5.9-5.9l-2.264-2.264l-5.9,5.9L9.129,6.775L6.865,9.04L12.833,15.008z',
		a:''
		
	}

	var UnitModel = Backbone.Model.extend({
			defaults:{
				id: undefined,
				name: undefined,
				type: undefined,
				location: [{longitude:undefined, latitude:undefined }],
				time: undefined
			},
			initialize: function(){

			},
			merge: function(model){
				var location = _.isArray(this.attributes.location) ? this.attributes.location : [this.attributes.location];
				
				location.push(model.location);
				
				this.set({location: location});				
			}
	});
	var UnitCollection = Backbone.Collection.extend({
	  	model: UnitModel,
		initialize: function(){
			
		},
		add: function(models, options){
			if(!models.id) models.id = models._id;
			
			var stored = this.get(models.id);
			
			if(stored) {
				stored.merge(models);
				this.trigger('merge', models);
			}else{
				Backbone.Collection.prototype.add.call(this, models, options);
			}
		}
	});                                                              

	var UnitList = Backbone.View.extend({
		tagName: 'div',
		className: 'main list',
		id: '',
		units: {},
		initialize: function(){
			_.bindAll(this, 'addOne', 'updateOne', 'loadAll', 'render');
			
			Units.bind('add', this.addOne);
			Units.bind('merge', this.updateOne);
			
		},
		render: function(){
			this.el.innerHTML = '<ul id="list"></ul><div id="unitInfoWrap"></div>';
			this.loadAll();
			$('#mainWrap').prepend(this.el);
			return this;
		},
		addOne: function(unit){

			var view = new UnitView(unit);
			this.units[view.id] = view;
////
		//	if(((Date.now() - view.options.attributes.location.time)/ 1000 / 60 / (120*24*9)) < 1) 
				this.$('ul#list').append(view.render().el);
		},
		updateOne: function(unit){
			this.units[unit.id].render();
		},
		loadAll: function(){
			Units.each(this.addOne)
		}
	});	
	var UnitView = Backbone.View.extend({
		tagName: 'li',
		template: _.template($('#unit-template').html()),
		events: {
			'click a' : 'loadUnit',
			'dblclick a' : 'render'
		},
		initialize: function(){
			_.bindAll(this, 'render', 'getTime', 'loadUnit');
			
		},
		render: function(){
			var location = this.location = _.isArray(this.options.attributes.location) ? _.last(this.options.attributes.location) : this.options.attributes.location;
			this.el.innerHTML = this.template({unitid: this.options.attributes.name || this.options.id, time: this.getTime(location.time), state : this.options.attributes.sos || false });
			return this;
		},
		getTime: function(t){
			var minutes = ~~((Date.now() - t) / 1000 / 60), 
			time =  ~~(minutes/1440) == 1 ? '1 day' : minutes > 1440 ? ~~(minutes/1440) + ' days' :  ~~(minutes/60) == 1 ? '1 hour' : minutes > 60 ? ~~(minutes/60) + ' hours' :  minutes > 1 ? minutes + ' mins' : '1 min';
			return time;
		},
		loadUnit: function(e){
			e.preventDefault();
			
			var data = this.options.attributes;
			data.location = this.location;
			var unitInfo = new UnitInfoView(data);
			$('#unitInfoWrap').html(unitInfo.render().el);
			$('#unitInfoWrap').hide().fadeTo(200,1);
		}
	});
	var UnitInfoView = Backbone.View.extend({
		tagName: 'div', className: 'info unit',
		fill: {'default': {fill: "90-#4B5357-#3C4347-#4B5357", stroke: "none"}},
		icons: {
			edit: icons.edit,
			history: icons.history
		},
		events:{
			'click nav a#edit': 'clicked',
			'click nav a#history': 'history',
			'click button#download' : 'download',
			'submit form#customDate' : 'historyCustomRange'
		},
		template: _.template($('#unit-info-template').html()),
		initialize: function(){
			_.bindAll(this, 'show');
		},
		render: function(){
			var that=this;
								
			this.el.innerHTML = this.template({id: this.options.id, name: this.options.name || this.options.id+'', model:this.options.model, location : this.options.location});
			
			_.each(this.icons, function(val, key){
				Raphael(that.$('nav #'+key)[0], 32, 32).path(val).attr({fill: '#444', stroke: 'none'}).scale(.8, .8, 0);	
			})
			return this;
		},
		clicked: function(e){
			e.preventDefault();
			var that = this;
			$.get('/units/'+this.options.id+'/edit', function(data){
				$(that.el).prepend(data);
			});
		},
		history: function(e, timeoffset){
			e.preventDefault();
			var $this = $(this.el),
				$wrapper = $this.parent(),
				historyView = new UnitHistoryView({prev: this, timeOffset : timeoffset || 0});
			
			$this.fadeOut(200);
			$wrapper.parent().animate({marginLeft: -140}, 200, function(){
				$this.hide();
				var historyEl = historyView.render().el;
				$wrapper.append(historyEl);
				$(historyEl).hide().fadeIn(200);
			});	
		},
		show: function(){
			var $this = $(this.el),
				$wrapper = $this.parent();
			
			$wrapper.parent().removeClass('full').animate({marginLeft: 80}, 200, function(){
				$this.fadeIn(200);			
			});
		},
		historyCustomRange: function(e){

    		var DAY = (1440 * 60 * 1000); 
    		var d = new Date(); 
    		var today = d.setHours(0,0,0,0); 
    		var val = $(this.el).find('input#daterange')[0].valueAsNumber; 
    		var offset = Math.floor(today/DAY - val/DAY);
            
            this.history(e, offset);
                		
    		return false;
    		
		}, 
		download: function(e){
		
		
		  e.preventDefault();
		  var DAY = (1440 * 60 * 1000); 
		  var d = new Date(); 
		  var today = d.setHours(0,0,0,0); 
		  var val = $(this.el).find('input#daterange')[0].valueAsNumber; 
		  var offset = Math.floor(today/DAY - val/DAY);
		
	
		  var that = this,
		      unit = this.options;
			  document.location.href=('units/'+unit.id+'/history/'+(offset||0)+'.csv');
		}
	});
	var UnitHistoryView = Backbone.View.extend({
		tagName: 'div', className: 'history full',
		events: {
			'click a#close': 'close'
		},
		icons: {
			close: icons.close
		},	
		mapOptions: {
			mapTypeControlOptions: {
				mapTypeIds: ['Map', google.maps.MapTypeId.SATELLITE]
			},
			zoom: 3,
			minZoom: 2,
		    center: undefined,
		    mapTypeId: 'Map'
		},
		template: _.template($('#unit-history-template').html()),
		initialize: function(){
			_.bindAll(this, 'getHistory');
			this.styledMapType = new google.maps.StyledMapType([{              
		        featureType: 'all',
		        stylers: [
		          {saturation: -100},
		          {gamma: 0.50}
		        ]
		   	}], {name: 'Map'});
			this.mapOptions.center = new google.maps.LatLng(0, 0);
			
		},
		render: function(){
			this.el.innerHTML = this.template({unit: this.options.prev.options, meta: this.options.timeOffset});
			
			
			var that = this;
			
			this.map = new google.maps.Map(that.$('#map')[0], that.mapOptions);
			this.map.mapTypes.set('Map', that.styledMapType);
			
			
		    setTimeout(function(){ google.maps.event.trigger(this.map, 'resize'); },50);
			
			var close = Raphael(this.$('a#close')[0], 30,30);
			this.getHistory();

			close.path(this.icons.close).attr({fill: '90-#777-#444', stroke:0}).scale(.5,.5);
			return this;
		},
		getHistory: function(){
			var that = this,
				unit = this.options.prev.options;
				console.log('units/'+unit.id+'/history/'+this.options.timeOffset);
			$.getJSON('units/'+unit.id+'/history/'+this.options.timeOffset, function(data){
				/*var timeline = Raphael(that.$('#timeline')[0], 200, 20+(data.length*20));
				timeline.timeline({data: data, onClick: function(unit){
					var LatLng = new google.maps.LatLng(unit.latitude, unit.longitude);
					
					that.marker.setPosition(LatLng);
					that.map.panTo(LatLng);					
				}});
				var LatLng = new google.maps.LatLng(data[0].latitude, data[0].longitude), icon = new google.maps.MarkerImage('./images/blueMarker.png', new google.maps.Size(16, 16), new google.maps.Point(0,0), new google.maps.Point(8, 8));
				that.map.panTo(LatLng);	that.map.setZoom(16);
				that.marker = new google.maps.Marker({
			      position: LatLng, 
			      map: that.map, 
				  icon: icon
				});*/
				_.each(data, function(item){
				var LatLng = new google.maps.LatLng(item.latitude, item.longitude), icon = new google.maps.MarkerImage('./images/blueMarker.png', new google.maps.Size(16, 16), new google.maps.Point(0,0), new google.maps.Point(8, 8));
				that.map.panTo(LatLng);	that.map.setZoom(16);
				that.marker = new google.maps.Marker({
			      position: LatLng, 
			      map: that.map, 
				  icon: icon
    				
				});
				});
				
				
			});
		},
		close: function(){
			var that=this;
			$(this.el).fadeOut(200, function(){
				that.remove();
				that.options.prev.show();				
			});	
		}
	});
	
	var LiveView = Backbone.View.extend({
		tagName: 'div',
		className: 'main',
		id: 'liveMap',
		popupTemplate: _.template($('#map-popup-template').html()),
		units: {}, heblocations:{},
		mapOptions: {
			mapTypeControlOptions: {
				mapTypeIds: ['Map', google.maps.MapTypeId.SATELLITE]
			},
			zoom: 8,
			minZoom: 2,
		    center: undefined,
		    mapTypeId: 'Map'
		},
		events: {},
		initialize: function(){
			_.bindAll(this, 'addUnit', 'loadAll', 'updateOne', 'getTime', 'resizeMap');
		  	var that = this;
			var styledMapType = new google.maps.StyledMapType([{              
		        featureType: 'all',
		        stylers: [
		          {saturation: -100},
		          {gamma: 0.50}
		        ]
		   	}], {name: 'Map'});
		
			this.mapOptions.center = new google.maps.LatLng(26.5741, -98.5189);
			
			
			Units.bind('add', this.addUnit);
			Units.bind('merge', this.updateOne);		
		
			this.map = new google.maps.Map(that.el, that.mapOptions);
			var hebButton = this.customButton('HEB');
			
			$(hebButton).click(function(){
			
			that.addHEBLocations(that.map);
			
			});
			
			this.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(hebButton);

		    this.map.mapTypes.set('Map', styledMapType);
			
			this.bounds = new google.maps.LatLngBounds();
			
			this.loadAll();
		},
		render: function(){
			$('#mainWrap').append(this.el);
			google.maps.event.trigger(this.map, 'resize');
			this.resizeMap(); 
			
		},
		addUnit: function(unit){
			var that = this,
				filter = false,
				location = _.isArray(unit.attributes.location) ? _.last(unit.attributes.location) : unit.attributes.location;
				LatLng = new google.maps.LatLng(location.latitude, location.longitude),
				icon = new google.maps.MarkerImage('./images/blueMarker.png', new google.maps.Size(16, 16), new google.maps.Point(0,0), new google.maps.Point(8, 8));
				marker = new google.maps.Marker({
			      position: LatLng, 
			      map: that.map, 
				  	icon: icon
				});

			this.infobox(marker, unit);
			
			this.units[unit.id] = marker;
			if(((Date.now() - location.time)/ 1000 / 60 / 120) < 1) this.bounds.extend(LatLng);
			this.resizeMap(); 
			
				
		},
		updateOne: function(unit){
			var LatLng = new google.maps.LatLng(unit.location.latitude, unit.location.longitude),
 				marker = this.units[unit.id];
				marker.setPosition(LatLng);
				
				this.bounds.extend(LatLng);
				this.resizeMap();
		},
		loadAll: function(){
		var that = this;
			Units.each(function(unit){
				var location = _.isArray(unit.attributes.location) ? _.last(unit.attributes.location) : unit.attributes.location;
				if(((Date.now() - location.time)/ 1000 / 60 / 120) < 1) 
					that.addUnit(unit);
			});
		},
		infobox: function(marker, unit){
			var that = this,
		 		location = _.isArray(unit.get('location')) ? _.last(unit.get('location')) : unit.get('location'),
				infobox = new InfoBox({
	                 content: this.popupTemplate({unitid: unit.get('name') || unit.id, model: unit.get('model') || 'Unknown', time: this.getTime(location.time)})
					,alignBottom: true
	                ,disableAutoPan: false
	                ,maxWidth: 0
	                ,pixelOffset: new google.maps.Size(-100, -40)
	                ,zIndex: null
	                ,boxStyle: { height: 'auto', width: 'auto'}
	                ,infoBoxClearance: new google.maps.Size(20, 20)
	                ,isHidden: false
	                ,pane: "floatPane"
					,closeBoxURL: ''
	                ,enableEventPropagation: false
	        	});	
			
			google.maps.event.addListener(marker, 'hideBox', function(){
				infobox.setOptions({
					pixelOffset: new google.maps.Size(-100, -34),
					boxClass: 'infoBox'
	          	});
				infobox.close();
				//that.resizeDisable = false;
			});
			google.maps.event.addListener(marker, 'click', function() {
				_.each(that.units, function(unit){ google.maps.event.trigger(unit, 'hideBox'); });
				infobox.open(that.map,this);
				that.resizeDisable = true;		
			});
			google.maps.event.addListener(that.map, 'click', function(e){
				_.each(that.units, function(unit){ google.maps.event.trigger(unit, 'hideBox'); });
			});
			google.maps.event.addListener(infobox, 'domready',function(){
				var box = this.div_;
				google.maps.event.addDomListener(box, 'click', function(e){
					if(!e.target.href){
						that.map.panTo(marker.getPosition());
						var bOpt = (infobox.boxClass_ == 'infoBox expand')? {pixelOffset: new google.maps.Size(-100, -34), boxClass: 'infoBox'}: {pixelOffset: new google.maps.Size(-138, -34), boxClass: 'infoBox expand'};
						infobox.setOptions(bOpt);
					}	
				});
			});
		},
		resizeMap: function(){
			if(!this.resizeDisable)
				this.map.fitBounds(this.bounds);
		},
		getTime: function(t){
			var minutes = ~~((Date.now() - t) / 1000 / 60), 
				time =  ~~(minutes/1440) == 1 ? '1 day' : minutes > 1440 ? ~~(minutes/1440) + ' days' :  ~~(minutes/60) == 1 ? '1 Hour' : minutes > 60 ? ~~(minutes/60) + ' hours' :  minutes > 1 ? minutes + ' minutes' : '1 minute';
			return time;
		},
		customButton: function(label){
			var controlDiv = document.createElement('div');

			// Set CSS styles for the DIV containing the control
			// Setting padding to 5 px will offset the control
			// from the edge of the map.
			controlDiv.style.padding = '5px';
			
			// Set CSS for the control border.
			var controlUI = document.createElement('div');
			controlUI.style.backgroundColor = 'white';
			controlUI.style.borderStyle = 'solid';
			controlUI.style.borderWidth = '2px';
			controlUI.style.cursor = 'pointer';
			controlUI.style.textAlign = 'center';
			controlUI.title = 'Click to set the map to Home';
			controlDiv.appendChild(controlUI);
			
			// Set CSS for the control interior.
			var controlText = document.createElement('div');
			controlText.style.fontFamily = 'Arial,sans-serif';
			controlText.style.fontSize = '12px';
			controlText.style.paddingLeft = '4px';
			controlText.style.paddingRight = '4px';
			controlText.innerHTML = '<strong>'+label+'<strong>';
			controlUI.appendChild(controlText);
			return controlDiv;
			
		},
		addHEBLocations: function(map){
			var that = this;
			$.getJSON('/heblocations.json',function(data){
				_.each(data, function(location){
				
				var LatLng = new google.maps.LatLng(location.Lat*1, location.Long*1),
					icon = new google.maps.MarkerImage('./images/hebicon.png', new google.maps.Size(16, 17), new google.maps.Point(0,0), new google.maps.Point(8, 8));
					marker = new google.maps.Marker({
			      		position: LatLng, 
			      		map: map, 
				  		icon: icon
					});
				that.heblocations[location.Corp] = marker;
				});
			});
		}	
	});

	var UsersList = Backbone.View.extend({
		tagName: 'div', className: 'main list', id: 'UsersView',
		users: {},
		events: {
			'click li#add a': 'createUser'
		},
		initialize: function(){
			_.bindAll(this, 'render', 'addUser');
			this.loadAllUsers();
			
		},
		render: function(){
			this.el.innerHTML = '<ul id="list"><li id="add"><a href="#">Add New User</a></li></ul><div id="userInfoWrap"></div>';

			$('#mainWrap').prepend(this.el);
			return this;
		},
		createUser: function(){
			var that=this;
			$.get('/users/new', function(data){
				
				$(that.el).prepend(data);
			});
		},
		addUser: function(user){
			var view = new UserView(user);
			
			this.$('ul').prepend(view.render().el);
		},
		loadAllUsers: function(){
			var that = this;
			$.getJSON('/users/all.json', function(users){
				_.each(users, that.addUser);
			});
	
		}
	});
	var UserView = Backbone.View.extend({
		tagName: 'li', 
		template: _.template($('#user-list-template').html()),
		events: {
			'click a' : 'loadUser'
		},
		initialize: function(){
			_.bindAll(this, 'formateDate', 'loadUser')
		},
		render: function(){
			this.options.lastLoggedIn = this.formatDate(this.options.lastLoggedIn);
			this.el.innerHTML = this.template(this.options);
			return this;
		},
		formatDate: function(time){
			if(!time) return 'Unknown';
			
			var d = new Date(time*1);
			return d.toLocaleDateString() +' '+d.toLocaleTimeString().replace(/\s[A-Z]{3}/, '');
		},
		loadUser: function(e){
			e.preventDefault();
			
			var data = this.options,
				userInfo = new UserInfoView(data);
			
			$('#userInfoWrap').html(userInfo.render().el);
			$('#userInfoWrap').hide().fadeTo(200,1);
		}
	});
	var UserInfoView = Backbone.View.extend({
		tagName: 'div', className: 'info user',
		template: _.template($('#user-info-template').html()),
		icons: {
			edit: icons.edit,
			units: icons.units
		},
		events:{
			'click nav a#edit': 'edit',
			'click nav a#units': 'units'
		},
		initialize: function(){

		},
		render: function(){
			var that = this;
			this.el.innerHTML = this.template(this.options);
			
			_.each(this.icons, function(val, key){
				Raphael(that.$('nav #'+key)[0], 32, 32).path(val).attr({fill: '#444', stroke: 'none'}).scale(.8, .8, 0);	
			})
			return this;
		},
		units: function(e){
			e.preventDefault();
			var $this = $(this.el),
				$wrapper = $this.parent(),
				historyView = new UserUnitsView({prev: this});
			
			$this.fadeOut(200);
			$wrapper.parent().animate({marginLeft: -140}, 200, function(){
				$this.hide();
				var historyEl = historyView.render().el;
				$wrapper.append(historyEl);
				$(historyEl).hide().fadeIn(200);
			});	
		},
		show: function(){
			var $this = $(this.el),
				$wrapper = $this.parent();
			
			$wrapper.parent().removeClass('full').animate({marginLeft: 80}, 200, function(){
				$this.fadeIn(200);			
			});
		}
	});
	var UserUnitsView = Backbone.View.extend({
		tagName: 'div', className: 'userUnits full',
		events: {
			'click a#close': 'close'
		},
		icons: {
			close: icons.close
		},
		template: _.template($('#user-units-template').html()),
		initialize: function(){
		},
		render: function(){
			this.el.innerHTML = this.template({user: this.options.prev.options});
			var p = Raphael(this.$('a#close')[0], 30,30);
			
			this.getUnits();
			
			p.path(this.icons.close).attr({fill: '90-#777-#444', stroke:0}).scale(.5,.5);
			return this;
		},
		getUnits: function(){
			var that=this,
				user = this.options.prev.options,
				isAdmin = (user.access == '0' || user.access == '1') ? true : false,
				$grid = this.$('ul#grid');
				
				this.globalAccessCheck();
			Units.each(function(unit){
				var view = new UserUnitItemView({prev: that, user: user, unit: unit.attributes});
				$grid.append( view.render().el );					
			});
		},
		globalAccessCheck : function(){
			var user = this.options.prev.options,
				$grid = this.$('ul#grid');

			user.isAdmin = (user.access == '0' || user.access == '1') ? true : false;
			
			if(user.isAdmin && _.isEmpty(user.units)) {
				$grid.addClass('global');
				user.global = true;
			}else{
				user.global = false;
			} 
		},
		close: function(){
			var that=this;
			$(this.el).fadeOut(200, function(){
				that.remove();
				that.options.prev.show();				
			});
			
		}
		
	});
	var UserUnitItemView = Backbone.View.extend({
		tagName: 'li',
		template: _.template('<a href="#/users/<%=unit.id%>/unit"><span><%=unit.id%></span><b><%=unit.model%></b><h1><%=unit.name||unit.id%></h1></a>'),
		events: {
			'click a': 'toggleUnit'
		},
		initialize: function(){

		},
		render: function(){
			var unit = this.options.unit,
				user = this.options.user,

				visibility = (_.indexOf(user.units, unit.id) === -1) ? 'invisible' : 'visible';

			$(this.el).addClass(visibility);
			this.el.innerHTML = this.template({unit: unit})
			return this;
		},
		toggleUnit: function(e){
			e.preventDefault();

			var $this = $(this.el),
				user = this.options.user,
				unit = this.options.unit,
				change = $this.hasClass('change'),
				visible = $this.hasClass('visible'),
				url = '/users/'+unit.id+'/unit',
				action = visible ? 'remove' : 'add';
			
		
								
			if(!change){
				$this.toggleClass('change').toggleClass('visible').toggleClass('invisible');
				$.ajax({
					type: 'POST',
					url: url, 
					data: {_method: 'PUT', action: action, email: user.email}, 
					success: function(res){
						var data = $.parseJSON(res);
						if(action == 'remove') user.units = _.without(user.units, unit.id);
						else if(action == 'add') user.units.push(unit.id);
						
						if(user.isAdmin){
							if(_.isEmpty(user.units)) $this.parent().addClass('global');
							else $this.parent().removeClass('global');
						}
						
						if(data.status === 'ok'){
							$this.toggleClass('change')
						}else if(data.status === 'error'){
							$this.toggleClass('visible').toggleClass('invisible');
						}
					}
				});
			} 	
			
		}
	});
	
	var NavigationItem = Backbone.View.extend({
		tagName: 'li',
		template: _.template('<a id="<%=name.toLowerCase()%>" href="#"></a><span><%=name%></span>'),
		fill: {'default': {fill: "0-#6f6f6f-#b1b1b1", stroke: 'black', 'stroke-opacity': 0.1, opacity: .8}, active: {fill: "#fff", opacity: .8}} ,
		stroke : {stroke: "#fff", "stroke-width": 3, "stroke-linejoin": "round", opacity: 0},
		icons: {
			error: icons.error,
			profile: icons.profile,
			users: icons.users,
			settings: icons.settings,
			cog: icons.cog,
			units: icons.units,
			live: icons.live
		},
		events: {
			'click' : 'clicked',
			'mouseover a' : 'mouseover',
			'mouseout a' : 'mouseout',
			'error'	: 'error'
		},
		initialize: function(){
			_.bindAll(this, 'error');

			this.active = false;
		},
		render: function(){
			var name = this.options.name.toLowerCase();
			this.el.innerHTML = this.template({name:this.options.name});
			var r = Raphael(this.$('#'+name)[0], 43, 43);
			this.icon = r.path(this.icons[name]).attr(this.fill[this.options.fill]).scale(1.3, 1.3, 0, 0);
			if(name == 'units') {

			}
			return this; 
		},
		mouseover: function(){
			this.$('span').stop().css({display:'block'}).animate({opacity: 1, left: 85}, 300);
            
		},
		mouseout: function(){
			this.$('span').stop().animate({opacity: 0, left: 60}, 300, function(){
				$(this).css({display:'none'});
			})
		},
		clicked: function(e){
			e.preventDefault();
			var that = this;
			if(!this.active){
				_.each(app.nav, function(nav){
					nav.active = that.options.name === nav.options.name ? true : false;
					var fill = nav.active ? 'active': 'default';
					nav.icon.attr(nav.fill[fill]);
					
					nav.el.className = fill;	
	
				});
				window.app.trigger('loadView', this.options.name);
			}
			
		},
		error: function(){
			console.log('sos');
		}
	});
	
/*	bootstrapped */	
	var Application = Backbone.Model.extend({
		navigation: 'Live,Units,Profile,Users'.split(','), nav: [],
		view : undefined,
		views : {
			units : UnitList,
			live : LiveView,
			profile : undefined,
			users : UsersList
		},
		initialize: function(){
			_.bindAll(this, 'loadView', 'sos');
			this.bind('loadView', this.loadView);
			this.renderNavigation();
			this.pubsub();
			this.getRegisteredUnits();
		},
		renderNavigation: function(){
			var that = this;
			if(!(window.appLocals.access == '1' || window.appLocals.access == '0') ) {this.navigation =_.without(this.navigation, 'Users');}
			_.each(this.navigation, function(nav){
				var navItem = new NavigationItem({name: nav, fill: 'default'});
				that.nav.push(navItem);
				$('#mainNav').append(navItem.render().el);
			});
		},
		loadView: function(name){
			var View = this.views[name.toLowerCase()];
			
			if(this.view !== undefined){
				this.view.remove();
				delete Units._callbacks;
			} 
			this.view = undefined;
					
			if(View !== undefined){	
				this.view = new View();
				this.view.render();
				
			}
		},
		getRegisteredUnits: function(){
			$.getJSON('/units/all.json', function(data){
				
				_.each(data, function(item){
					Units.add(item);
				});
			});
		},
		pubsub: function(){
			var that = this, socket = new io.Socket(null, {port: 80}); 
			socket.on('connect', function(){ socket.send({sessionID: window.appLocals.sessionSocketID}); $('title').html('Safetrack - Connected')});
			socket.on('disconnect', function() {
				var interval;
				function connect() {
					if (socket.connected) {
					    clearInterval(interval);
					} else {
					    socket.connect();
					}
				}
				$('title').html('Disconnected')
				connect();
				interval = setInterval(connect, 1000);
		    });
		    
			socket.on('message', function(message){
				if(message.event == 'unit.location')
					Units.add(message.data);
				if(message.event == 'unit.sos') that.sos(message.data)
				console.log(message.event, message);

			});
			socket.connect();
		},
		sos: function(data){
			var navUnits = _.select(app.nav, function(obj){ return obj.options.name == 'Units'});

				if(data.longitude || data.latitude) Units.add(data);
				Units._byId[data.id].set({sos:true});
				
				window.app.nav[1].icon.attr({fill :'red'})
		}
	});
	
	window.Units = new UnitCollection();
	window.app = new Application();
	
	$('#cancel').live('click', function(){
		$('.popup:first').remove();
		return false;
	});
});